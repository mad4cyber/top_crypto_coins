<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Exchange Integration - Crypto AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
        .card { backdrop-filter: blur(10px); background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .text-white { color: white !important; }
        .exchange-status-online { color: #28a745; }
        .exchange-status-offline { color: #dc3545; }
        .exchange-status-degraded { color: #ffc107; }
        .arbitrage-card { transition: transform 0.2s; }
        .arbitrage-card:hover { transform: scale(1.02); }
        .profit-positive { color: #28a745; font-weight: bold; }
        .profit-negative { color: #dc3545; font-weight: bold; }
        .spread-high { background: linear-gradient(45deg, #ff6b6b, #ee5a24); }
        .spread-medium { background: linear-gradient(45deg, #ffa726, #ff9800); }
        .spread-low { background: linear-gradient(45deg, #42a5f5, #2196f3); }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="text-white mb-0"><i class="fas fa-building-columns"></i> Multi-Exchange Integration</h1>
                        <p class="text-white-50 mb-0">Professional Multi-Exchange Trading & Arbitrage</p>
                    </div>
                    <div>
                        <button class="btn btn-success me-2" onclick="startMonitoring()">
                            <i class="fas fa-play"></i> Start Monitoring
                        </button>
                        <button class="btn btn-danger me-2" onclick="stopMonitoring()">
                            <i class="fas fa-stop"></i> Stop Monitoring
                        </button>
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exchange Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white h-100">
                    <div class="card-body text-center">
                        <h3 class="mb-0" id="totalExchanges">-</h3>
                        <p class="mb-0">Total Exchanges</p>
                        <small class="text-success" id="onlineExchanges">- online</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white h-100">
                    <div class="card-body text-center">
                        <h3 class="mb-0 text-success" id="portfolioValue">$-</h3>
                        <p class="mb-0">Total Portfolio</p>
                        <small class="text-white-50" id="uniqueAssets">- assets</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white h-100">
                    <div class="card-body text-center">
                        <h3 class="mb-0 text-warning" id="arbitrageCount">-</h3>
                        <p class="mb-0">Arbitrage Opportunities</p>
                        <small class="text-success" id="bestSpread">-% best spread</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white h-100">
                    <div class="card-body text-center">
                        <h3 class="mb-0 text-info" id="avgLatency">-ms</h3>
                        <p class="mb-0">Avg Latency</p>
                        <small class="text-white-50" id="monitoringStatus">Monitoring: -</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exchange Health Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card text-white">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-heartbeat"></i> Exchange Health Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="exchangeHealthContainer">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading exchange status...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unified Portfolio Balance -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card text-white">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-wallet"></i> Unified Portfolio Balance</h5>
                    </div>
                    <div class="card-body">
                        <div id="portfolioBalanceContainer">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading portfolio balance...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Arbitrage Opportunities -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card text-white">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-exchange-alt"></i> Arbitrage Opportunities</h5>
                            <button class="btn btn-sm btn-outline-light" onclick="scanArbitrage()">
                                <i class="fas fa-search"></i> Scan Now
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="arbitrageContainer">
                            <div class="text-center">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Scanning arbitrage opportunities...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="text-center">
                    <a href="/dashboard" class="btn btn-outline-light me-2">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </a>
                    <a href="/trading-interface" class="btn btn-outline-light me-2">
                        <i class="fas fa-chart-bar"></i> Trading Interface
                    </a>
                    <a href="/portfolio" class="btn btn-outline-light me-2">
                        <i class="fas fa-briefcase"></i> Portfolio
                    </a>
                    <a href="/" class="btn btn-outline-light">
                        <i class="fas fa-home"></i> Home
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let refreshInterval = null;
        let monitoringActive = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadExchangeData();
            checkMonitoringStatus();
            // Auto refresh every 30 seconds
            refreshInterval = setInterval(loadExchangeData, 30000);
        });

        async function loadExchangeData() {
            try {
                // Load summary data
                const summaryResponse = await fetch('/api/multi-exchange/summary');
                if (summaryResponse.ok) {
                    const summaryData = await summaryResponse.json();
                    updateSummaryCards(summaryData);
                }

                // Load exchange health
                const healthResponse = await fetch('/api/multi-exchange/connections');
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    updateExchangeHealth(healthData);
                }

                // Load unified balance
                const balanceResponse = await fetch('/api/multi-exchange/unified-balance');
                if (balanceResponse.ok) {
                    const balanceData = await balanceResponse.json();
                    updatePortfolioBalance(balanceData);
                }

                // Load arbitrage opportunities
                await loadArbitrageOpportunities();

            } catch (error) {
                console.error('Error loading exchange data:', error);
                showError('Failed to load exchange data');
            }
        }

        function updateSummaryCards(data) {
            document.getElementById('totalExchanges').textContent = data.total_exchanges || '-';
            document.getElementById('onlineExchanges').textContent = `${data.online_exchanges || 0} online`;
            document.getElementById('portfolioValue').textContent = `$${(data.total_portfolio_usd || 0).toLocaleString()}`;
            document.getElementById('uniqueAssets').textContent = `${data.unique_assets || 0} assets`;
            document.getElementById('arbitrageCount').textContent = data.arbitrage_opportunities_1h || 0;
            document.getElementById('bestSpread').textContent = `${(data.best_arbitrage_spread || 0).toFixed(2)}% best spread`;
            document.getElementById('avgLatency').textContent = `${Math.round(data.avg_latency_ms || 0)}ms`;
            
            const monitoringText = (data.health_monitoring_active ? 'Health ' : '') + 
                                 (data.arbitrage_monitoring_active ? 'Arbitrage' : '');
            document.getElementById('monitoringStatus').textContent = `Monitoring: ${monitoringText || 'Inactive'}`;
        }

        function updateExchangeHealth(data) {
            const container = document.getElementById('exchangeHealthContainer');
            
            if (!data.health_status || Object.keys(data.health_status).length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No exchange health data available</p>';
                return;
            }

            let html = '<div class="row">';
            
            Object.entries(data.health_status).forEach(([exchange, health]) => {
                const statusClass = health.status === 'online' ? 'exchange-status-online' : 
                                   health.status === 'offline' ? 'exchange-status-offline' : 'exchange-status-degraded';
                
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="card bg-dark">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0 text-capitalize">${exchange}</h6>
                                    <span class="${statusClass}">
                                        <i class="fas fa-circle"></i> ${health.status.toUpperCase()}
                                    </span>
                                </div>
                                <div class="row text-sm">
                                    <div class="col-6">
                                        <small class="text-muted">Latency:</small><br>
                                        <span class="text-white">${Math.round(health.latency_ms)}ms</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Uptime:</small><br>
                                        <span class="text-success">${health.uptime_pct.toFixed(1)}%</span>
                                    </div>
                                </div>
                                <div class="row text-sm mt-2">
                                    <div class="col-6">
                                        <small class="text-muted">Error Rate:</small><br>
                                        <span class="text-warning">${health.error_rate.toFixed(1)}%</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">API Calls:</small><br>
                                        <span class="text-info">${health.api_calls_remaining}</span>
                                    </div>
                                </div>
                                ${health.issues && health.issues.length > 0 ? `
                                    <div class="mt-2">
                                        <small class="text-danger">Issues: ${health.issues.join(', ')}</small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function updatePortfolioBalance(data) {
            const container = document.getElementById('portfolioBalanceContainer');
            
            if (!data || Object.keys(data).length <= 1) { // Only _summary
                container.innerHTML = '<p class="text-center text-muted">No portfolio balance data available</p>';
                return;
            }

            let html = '<div class="row">';
            
            Object.entries(data).forEach(([asset, info]) => {
                if (asset === '_summary') return;
                
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="card bg-dark">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">${asset}</h6>
                                    <span class="text-success">$${info.total_usd_value.toLocaleString()}</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Total Balance:</small>
                                    <span class="text-white d-block">${info.total_balance.toFixed(6)}</span>
                                </div>
                                <div class="row text-sm">
                `;
                
                Object.entries(info.exchanges).forEach(([exchange, exchangeInfo]) => {
                    html += `
                        <div class="col-12 mb-1">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">${exchange.charAt(0).toUpperCase() + exchange.slice(1)}:</small>
                                <small class="text-white">${exchangeInfo.balance.toFixed(6)}</small>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (data._summary) {
                html += `
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card bg-primary">
                                <div class="card-body text-center">
                                    <h4 class="mb-0">Total Portfolio Value: $${data._summary.total_usd_value.toLocaleString()}</h4>
                                    <small>${data._summary.asset_count} assets across ${data._summary.exchange_count} exchanges</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        async function loadArbitrageOpportunities() {
            try {
                const response = await fetch('/api/multi-exchange/arbitrage?symbols=BTCUSDT&symbols=ETHUSDT&symbols=BNBUSDT&symbols=ADAUSDT');
                const container = document.getElementById('arbitrageContainer');
                
                if (!response.ok) {
                    throw new Error('Failed to load arbitrage data');
                }
                
                const opportunities = await response.json();
                
                if (!opportunities || opportunities.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">No arbitrage opportunities found</p>';
                    return;
                }

                let html = '<div class="row">';
                
                opportunities.forEach((opp, index) => {
                    const spreadClass = opp.spread_pct >= 2 ? 'spread-high' : 
                                       opp.spread_pct >= 1 ? 'spread-medium' : 'spread-low';
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="card arbitrage-card ${spreadClass}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0 text-white">${opp.symbol}</h6>
                                        <span class="badge bg-light text-dark">${opp.spread_pct.toFixed(2)}% Spread</span>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-6">
                                            <small class="text-white-75">Buy at ${opp.buy_exchange}:</small>
                                            <div class="text-white fw-bold">$${opp.buy_price.toFixed(4)}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-white-75">Sell at ${opp.sell_exchange}:</small>
                                            <div class="text-white fw-bold">$${opp.sell_price.toFixed(4)}</div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-white-75">Potential Profit:</small>
                                            <div class="profit-positive">$${opp.potential_profit.toFixed(2)}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-white-75">Volume:</small>
                                            <div class="text-white">${opp.volume.toFixed(4)}</div>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-light" role="progressbar" 
                                                 style="width: ${opp.confidence * 100}%"
                                                 aria-valuenow="${opp.confidence * 100}" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-white-75">Confidence: ${(opp.confidence * 100).toFixed(0)}%</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading arbitrage opportunities:', error);
                document.getElementById('arbitrageContainer').innerHTML = 
                    '<p class="text-center text-danger">Failed to load arbitrage opportunities</p>';
            }
        }

        async function startMonitoring() {
            try {
                const response = await fetch('/api/multi-exchange/monitoring/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        health_monitoring: true,
                        arbitrage_monitoring: true
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccess('Exchange monitoring started successfully');
                    monitoringActive = true;
                } else {
                    showError(result.error || 'Failed to start monitoring');
                }
            } catch (error) {
                console.error('Error starting monitoring:', error);
                showError('Failed to start monitoring');
            }
        }

        async function stopMonitoring() {
            try {
                const response = await fetch('/api/multi-exchange/monitoring/stop', {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    showSuccess('Exchange monitoring stopped');
                    monitoringActive = false;
                } else {
                    showError(result.error || 'Failed to stop monitoring');
                }
            } catch (error) {
                console.error('Error stopping monitoring:', error);
                showError('Failed to stop monitoring');
            }
        }

        async function checkMonitoringStatus() {
            try {
                const response = await fetch('/api/multi-exchange/monitoring/status');
                const status = await response.json();
                
                monitoringActive = status.health_monitoring_active || status.arbitrage_monitoring_active;
                
            } catch (error) {
                console.error('Error checking monitoring status:', error);
            }
        }

        function scanArbitrage() {
            document.getElementById('arbitrageContainer').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Scanning...</span>
                    </div>
                    <p class="mt-2">Scanning for arbitrage opportunities...</p>
                </div>
            `;
            
            setTimeout(() => {
                loadArbitrageOpportunities();
            }, 1000);
        }

        function refreshData() {
            showInfo('Refreshing exchange data...');
            loadExchangeData();
        }

        function showSuccess(message) {
            showAlert(message, 'success');
        }

        function showError(message) {
            showAlert(message, 'danger');
        }

        function showInfo(message) {
            showAlert(message, 'info');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ§  Crypto AI Predictor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .hero-section {
            padding: 100px 0;
            color: white;
            text-align: center;
        }
        .prediction-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            margin: 20px 0;
        }
        .prediction-result {
            display: none;
            margin-top: 20px;
        }
        .loading {
            display: none;
        }
        .price-change.positive {
            color: #28a745;
        }
        .price-change.negative {
            color: #dc3545;
        }
        .confidence-bar {
            height: 10px;
            border-radius: 5px;
            background: #e9ecef;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffc107 0%, #28a745 100%);
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-brain"></i> Crypto AI Predictor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/analysis">Multi-Coin Analysis</a>
                <a class="nav-link" href="/charts">Charts</a>
                <a class="nav-link" href="/portfolio">Portfolio</a>
                <a class="nav-link" href="/alerts">Alerts</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <h1 class="display-4 mb-4">
                <i class="fas fa-robot"></i> AI-Powered Crypto Predictions
            </h1>
            <p class="lead">Nutze Machine Learning fÃ¼r prÃ¤zise KryptowÃ¤hrungs-Prognosen</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mb-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="prediction-card p-4">
                    <h3 class="text-center mb-4">
                        <i class="fas fa-chart-line text-primary"></i> 
                        AI-Prognose erstellen
                    </h3>
                    
                    <!-- Coin Selection -->
                    <div class="mb-3">
                        <label for="coinSelect" class="form-label">KryptowÃ¤hrung auswÃ¤hlen:</label>
                        <select id="coinSelect" class="form-select">
                            <option value="">-- Coin auswÃ¤hlen --</option>
                            <option value="bitcoin">Bitcoin (BTC)</option>
                            <option value="ethereum">Ethereum (ETH)</option>
                            <option value="tether">Tether (USDT)</option>
                            <option value="binancecoin">Binance Coin (BNB)</option>
                            <option value="solana">Solana (SOL)</option>
                            <option value="ripple">Ripple (XRP)</option>
                            <option value="usd-coin">USD Coin (USDC)</option>
                            <option value="staked-ether">Lido Staked Ether (stETH)</option>
                            <option value="dogecoin">Dogecoin (DOGE)</option>
                            <option value="cardano">Cardano (ADA)</option>
                            <option value="tron">TRON (TRX)</option>
                            <option value="shiba-inu">Shiba Inu (SHIB)</option>
                            <option value="avalanche-2">Avalanche (AVAX)</option>
                            <option value="chainlink">Chainlink (LINK)</option>
                            <option value="polygon">Polygon (MATIC)</option>
                        </select>
                    </div>

                    <!-- Predict Button -->
                    <div class="text-center mb-3">
                        <button id="predictBtn" class="btn btn-primary btn-lg" disabled>
                            <i class="fas fa-magic"></i> AI-Prognose erstellen
                        </button>
                    </div>

                    <!-- Loading -->
                    <div class="loading text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Analysiere...</span>
                        </div>
                        <p class="mt-2">ðŸ§  AI analysiert historische Daten...</p>
                    </div>

                    <!-- Prediction Result -->
                    <div class="prediction-result">
                        <!-- Confidence Warning Alert -->
                        <div id="confidenceAlert" class="alert" style="display: none;">
                            <h6 id="confidenceWarning"></h6>
                            <p id="confidenceRecommendation" class="mb-0"></p>
                        </div>

                        <!-- Interactive Chart -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>ðŸ“Š Interactive Chart with AI Predictions</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary active" onclick="setChartTimeframe('1D')">1D</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="setChartTimeframe('1W')">1W</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="setChartTimeframe('1M')">1M</button>
                                </div>
                            </div>
                            <div id="tradingview_chart" style="height: 400px; border-radius: 10px; overflow: hidden;"></div>
                            <div class="mt-2 text-center">
                                <small class="text-muted">
                                    <i class="fas fa-chart-line"></i> Professional charts powered by TradingView
                                    | <span id="chartSymbol">--</span> | 
                                    <span class="text-success">ðŸ“ˆ AI Prediction: <span id="chartPrediction">--</span></span>
                                </small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="text-center p-3 border rounded">
                                    <h5>Aktueller Preis</h5>
                                    <div id="currentPrice" class="h4 text-muted">--</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-3 border rounded">
                                    <h5>24h Prognose</h5>
                                    <div id="predictedPrice" class="h4">--</div>
                                    <div id="priceChange" class="price-change">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Trading Signal -->
                        <div class="mt-3">
                            <div class="text-center p-3 border rounded">
                                <h6>AI Trading Signal</h6>
                                <div id="tradingSignal" class="h5">--</div>
                                <small id="signalStrength" class="text-muted">--</small>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h6>AI-Konfidenz & Risk Assessment:</h6>
                            <div class="confidence-bar">
                                <div id="confidenceFill" class="confidence-fill" style="width: 0%"></div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <div id="confidenceText" class="text-center">0%</div>
                                </div>
                                <div class="col-md-6">
                                    <div id="riskAssessment" class="text-center">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Market Sentiment -->
                        <div class="mt-4">
                            <h6>ðŸ“± Market Sentiment Analysis:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="text-center p-2 border rounded">
                                        <small class="text-muted">Market Mood</small>
                                        <div id="marketMood" class="fw-bold">--</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="text-center p-2 border rounded">
                                        <small class="text-muted">Fear & Greed</small>
                                        <div id="fearGreedIndex" class="fw-bold">--</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-4 text-center">
                                    <small class="text-muted">News Sentiment</small>
                                    <div id="newsSentiment" class="fw-bold">--</div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <small class="text-muted">Social Sentiment</small>
                                    <div id="socialSentiment" class="fw-bold">--</div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <small class="text-muted">Sentiment Boost</small>
                                    <div id="sentimentBoost" class="fw-bold text-info">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Risk Management -->
                        <div class="mt-4">
                            <h6>Risk Management:</h6>
                            <div class="row">
                                <div class="col-md-4 text-center">
                                    <small class="text-muted">Max Position</small>
                                    <div id="maxPosition" class="fw-bold">--</div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <small class="text-muted">Stop Loss</small>
                                    <div id="stopLoss" class="fw-bold text-danger">--</div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <small class="text-muted">Take Profit</small>
                                    <div id="takeProfit" class="fw-bold text-success">--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Model Performance -->
                        <div class="mt-4">
                            <h6>Modell-Performance:</h6>
                            <div id="modelPerformance"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mt-5">
            <div class="col-md-4 text-center text-white">
                <i class="fas fa-brain fa-3x mb-3"></i>
                <h5>Machine Learning</h5>
                <p>Multiple AI-Modelle fÃ¼r prÃ¤zise Prognosen</p>
            </div>
            <div class="col-md-4 text-center text-white">
                <i class="fas fa-chart-area fa-3x mb-3"></i>
                <h5>Technische Analyse</h5>
                <p>RSI, MACD, Bollinger Bands und mehr</p>
            </div>
            <div class="col-md-4 text-center text-white">
                <i class="fas fa-shield-alt fa-3x mb-3"></i>
                <h5>Risk Management</h5>
                <p>Konfidenz-basierte Empfehlungen</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        const coinSelect = document.getElementById('coinSelect');
        const predictBtn = document.getElementById('predictBtn');
        const loading = document.querySelector('.loading');
        const predictionResult = document.querySelector('.prediction-result');

        // TradingView Chart Variables
        let tradingViewWidget = null;
        let currentChartSymbol = null;
        let currentTimeframe = '1D';
        let currentPredictionData = null;

        // Enable predict button when coin is selected
        coinSelect.addEventListener('change', function() {
            predictBtn.disabled = this.value === '';
        });

        // Predict button click handler
        predictBtn.addEventListener('click', async function() {
            const coinId = coinSelect.value;
            if (!coinId) return;

            // Show loading
            loading.style.display = 'block';
            predictionResult.style.display = 'none';
            predictBtn.disabled = true;

            try {
                // Fetch prediction from API
                const response = await fetch(`/api/predict/${coinId}`);
                const data = await response.json();

                if (data.error) {
                    alert('Fehler: ' + data.error);
                    return;
                }

                // Update UI with prediction data
                displayPrediction(data);

            } catch (error) {
                alert('Fehler beim Abrufen der Prognose: ' + error.message);
            } finally {
                // Hide loading
                loading.style.display = 'none';
                predictBtn.disabled = false;
            }
        });

        function displayPrediction(data) {
            // Confidence Analysis
            const confidenceAnalysis = data.confidence_analysis || {};
            const tradingAnalysis = data.trading_analysis || {};
            
            // Show confidence warning if needed
            const confidenceAlert = document.getElementById('confidenceAlert');
            const confidenceLevel = confidenceAnalysis.level || 'unknown';
            
            if (confidenceLevel === 'very_low' || confidenceLevel === 'low') {
                confidenceAlert.style.display = 'block';
                confidenceAlert.className = `alert alert-warning`;
                document.getElementById('confidenceWarning').textContent = confidenceAnalysis.warning || '';
                document.getElementById('confidenceRecommendation').textContent = confidenceAnalysis.recommendation || '';
            } else if (confidenceLevel === 'moderate') {
                confidenceAlert.style.display = 'block';
                confidenceAlert.className = `alert alert-info`;
                document.getElementById('confidenceWarning').textContent = confidenceAnalysis.warning || '';
                document.getElementById('confidenceRecommendation').textContent = confidenceAnalysis.recommendation || '';
            } else if (confidenceLevel === 'good' || confidenceLevel === 'very_high') {
                confidenceAlert.style.display = 'block';
                confidenceAlert.className = `alert alert-success`;
                document.getElementById('confidenceWarning').textContent = confidenceAnalysis.warning || '';
                document.getElementById('confidenceRecommendation').textContent = confidenceAnalysis.recommendation || '';
            }

            // Current and predicted prices
            document.getElementById('currentPrice').textContent = 
                `â‚¬${data.current_price.toFixed(2)}`;
            document.getElementById('predictedPrice').textContent = 
                `â‚¬${data.predicted_price.toFixed(2)}`;

            // Price change
            const changeElement = document.getElementById('priceChange');
            const change = data.price_change_pct;
            changeElement.textContent = `${change > 0 ? '+' : ''}${change.toFixed(2)}%`;
            changeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;

            // Trading Signal
            const signalElement = document.getElementById('tradingSignal');
            const signal = tradingAnalysis.signal || 'N/A';
            const signalColor = tradingAnalysis.signal_color || 'secondary';
            signalElement.textContent = signal;
            signalElement.className = `h5 text-${signalColor}`;
            
            document.getElementById('signalStrength').textContent = 
                `Signal Strength: ${tradingAnalysis.signal_strength || 0}`;

            // Confidence
            const confidence = data.confidence * 100;
            document.getElementById('confidenceFill').style.width = `${confidence}%`;
            document.getElementById('confidenceText').textContent = `${confidence.toFixed(1)}%`;
            
            // Risk Assessment
            const riskElement = document.getElementById('riskAssessment');
            const riskAssessment = confidenceAnalysis.risk_assessment || 'N/A';
            riskElement.textContent = `Risk: ${riskAssessment}`;
            
            if (riskAssessment.includes('SEHR HOCH') || riskAssessment.includes('HOCH')) {
                riskElement.className = 'text-center text-danger fw-bold';
            } else if (riskAssessment.includes('MITTEL')) {
                riskElement.className = 'text-center text-warning fw-bold';
            } else {
                riskElement.className = 'text-center text-success fw-bold';
            }

            // Market Sentiment Analysis
            const sentimentAnalysis = data.sentiment_analysis || {};
            
            document.getElementById('marketMood').textContent = 
                sentimentAnalysis.market_mood || 'Unknown';
            
            const fearGreed = sentimentAnalysis.fear_greed_index || 50;
            let fearGreedColor = 'text-warning';
            if (fearGreed > 75) fearGreedColor = 'text-success';
            else if (fearGreed < 25) fearGreedColor = 'text-danger';
            
            const fearGreedElement = document.getElementById('fearGreedIndex');
            fearGreedElement.textContent = `${fearGreed}/100`;
            fearGreedElement.className = `fw-bold ${fearGreedColor}`;
            
            // News & Social Sentiment
            const newsSent = sentimentAnalysis.news_sentiment || 0;
            const newsElement = document.getElementById('newsSentiment');
            newsElement.textContent = `${newsSent > 0 ? '+' : ''}${(newsSent * 100).toFixed(1)}%`;
            newsElement.className = `fw-bold ${newsSent > 0 ? 'text-success' : newsSent < 0 ? 'text-danger' : 'text-muted'}`;
            
            const socialSent = sentimentAnalysis.social_sentiment || 0;
            const socialElement = document.getElementById('socialSentiment');
            socialElement.textContent = `${socialSent > 0 ? '+' : ''}${(socialSent * 100).toFixed(1)}%`;
            socialElement.className = `fw-bold ${socialSent > 0 ? 'text-success' : socialSent < 0 ? 'text-danger' : 'text-muted'}`;
            
            // Sentiment Boost
            const boost = sentimentAnalysis.confidence_boost_applied || 1;
            document.getElementById('sentimentBoost').textContent = 
                `${((boost - 1) * 100).toFixed(0)}%`;

            // Risk Management
            document.getElementById('maxPosition').textContent = 
                `${tradingAnalysis.max_position_pct || 0}%`;
            document.getElementById('stopLoss').textContent = 
                `-${tradingAnalysis.stop_loss_pct || 0}%`;
            document.getElementById('takeProfit').textContent = 
                `+${tradingAnalysis.take_profit_pct || 0}%`;

            // Model performance
            const perfContainer = document.getElementById('modelPerformance');
            let perfHtml = '<div class="row">';
            
            for (const [model, perf] of Object.entries(data.model_performance || {})) {
                const r2Score = (perf.r2 * 100).toFixed(1);
                const r2Color = perf.r2 > 0.5 ? 'text-success' : perf.r2 > 0.2 ? 'text-warning' : 'text-danger';
                
                perfHtml += `
                    <div class="col-md-6 mb-2">
                        <small>
                            <strong>${model.replace('_', ' ').toUpperCase()}:</strong> 
                            <span class="${r2Color}">RÂ² ${r2Score}%</span>
                        </small>
                    </div>
                `;
            }
            
            perfHtml += '</div>';
            perfContainer.innerHTML = perfHtml;

            // Show result
            predictionResult.style.display = 'block';

            // Update TradingView Chart
            updateTradingViewChart(coinSelect.value, data);
        }

        function updateTradingViewChart(coinId, predictionData) {
            currentPredictionData = predictionData;
            
            // Map coin IDs to TradingView symbols
            const symbolMapping = {
                'bitcoin': 'BINANCE:BTCUSDT',
                'ethereum': 'BINANCE:ETHUSDT',
                'binancecoin': 'BINANCE:BNBUSDT',
                'ripple': 'BINANCE:XRPUSDT',
                'solana': 'BINANCE:SOLUSDT',
                'cardano': 'BINANCE:ADAUSDT',
                'dogecoin': 'BINANCE:DOGEUSDT',
                'tether': 'BINANCE:USDTUSDT',
                'usd-coin': 'BINANCE:USDCUSDT',
                'tron': 'BINANCE:TRXUSDT',
                'shiba-inu': 'BINANCE:SHIBUSDT',
                'avalanche-2': 'BINANCE:AVAXUSDT',
                'chainlink': 'BINANCE:LINKUSDT',
                'polygon': 'BINANCE:MATICUSDT'
            };

            const symbol = symbolMapping[coinId] || `BINANCE:${coinId.toUpperCase()}USDT`;
            currentChartSymbol = symbol;

            // Update chart info
            document.getElementById('chartSymbol').textContent = symbol;
            document.getElementById('chartPrediction').textContent = 
                `${predictionData.price_change_pct > 0 ? '+' : ''}${predictionData.price_change_pct.toFixed(2)}% (24h)`;

            // Create or update TradingView widget
            if (tradingViewWidget) {
                // Remove existing widget
                document.getElementById('tradingview_chart').innerHTML = '';
            }

            try {
                tradingViewWidget = new TradingView.widget({
                    autosize: true,
                    symbol: symbol,
                    interval: currentTimeframe,
                    container_id: "tradingview_chart",
                    theme: "dark",
                    style: "1",
                    locale: "en",
                    toolbar_bg: "#1e3c72",
                    enable_publishing: false,
                    hide_top_toolbar: false,
                    hide_legend: true,
                    save_image: false,
                    studies: [
                        "RSI@tv-basicstudies",
                        "MACD@tv-basicstudies",
                        "BB@tv-basicstudies"
                    ],
                    overrides: {
                        "paneProperties.background": "#1e3c72",
                        "paneProperties.backgroundGradientStartColor": "#1e3c72",
                        "paneProperties.backgroundGradientEndColor": "#2a5298"
                    }
                });

                // Add AI prediction annotation (when widget loads)
                setTimeout(() => {
                    addPredictionAnnotation(predictionData);
                }, 3000);

            } catch (error) {
                console.log('TradingView widget error:', error);
                document.getElementById('tradingview_chart').innerHTML = 
                    '<div class="d-flex justify-content-center align-items-center h-100 bg-light rounded">' +
                    '<div class="text-center">' +
                    '<i class="fas fa-chart-line fa-3x text-muted mb-3"></i>' +
                    '<p class="text-muted">Chart wird geladen...</p>' +
                    '</div></div>';
            }
        }

        function addPredictionAnnotation(predictionData) {
            // This would add AI prediction as chart annotation
            // TradingView's advanced features require subscription
            // For now, we show prediction info below chart
            console.log('AI Prediction:', predictionData);
        }

        function setChartTimeframe(timeframe) {
            // Update active button
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            currentTimeframe = timeframe;
            
            if (currentChartSymbol && currentPredictionData) {
                updateTradingViewChart(coinSelect.value, currentPredictionData);
            }
        }
    </script>
</body>
</html>
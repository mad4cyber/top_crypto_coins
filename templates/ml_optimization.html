<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ§  ML Portfolio Optimization - Crypto AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .optimization-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(15px);
            margin-bottom: 20px;
        }
        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            text-align: center;
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .ml-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .weight-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }
        .weight-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
        }
        .regime-bull { background: linear-gradient(45deg, #28a745, #20c997); }
        .regime-bear { background: linear-gradient(45deg, #dc3545, #c82333); }
        .regime-sideways { background: linear-gradient(45deg, #6c757d, #5a6268); }
        .regime-volatile { background: linear-gradient(45deg, #ffc107, #e0a800); }
        .trade-card {
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid transparent;
        }
        .trade-buy {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }
        .trade-sell {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.05);
        }
        .confidence-ring {
            width: 80px;
            height: 80px;
            margin: 0 auto;
        }
        .confidence-ring svg {
            transform: rotate(-90deg);
        }
        .optimization-timeline {
            max-height: 400px;
            overflow-y: auto;
        }
        .timeline-item {
            border-left: 2px solid #dee2e6;
            padding-left: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        .timeline-item::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            position: absolute;
            left: -5px;
            top: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-brain"></i> Crypto AI Predictor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link" href="/analysis">Analysis</a>
                <a class="nav-link" href="/charts">Charts</a>
                <a class="nav-link" href="/portfolio">Portfolio</a>
                <a class="nav-link" href="/alerts">Alerts</a>
                <a class="nav-link" href="/performance">Performance</a>
                <a class="nav-link active" href="/ml-optimization">ðŸ§  ML Optimization</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="optimization-card p-4 text-center">
                    <h2>ðŸ§  ML Portfolio Optimization</h2>
                    <p class="text-muted">Advanced machine learning algorithms for intelligent portfolio management</p>
                    <span class="ml-badge">Powered by AI</span>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row">
            <div class="col-12">
                <div class="optimization-card p-4">
                    <h5><i class="fas fa-cogs text-primary"></i> Optimization Control Panel</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Portfolio</label>
                            <select id="portfolioSelect" class="form-select">
                                <option value="Main Portfolio">Main Portfolio</option>
                                <option value="Conservative">Conservative</option>
                                <option value="Aggressive">Aggressive</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Optimization Type</label>
                            <select id="optimizationType" class="form-select">
                                <option value="risk_adjusted">Risk Adjusted</option>
                                <option value="conservative">Conservative</option>
                                <option value="aggressive">Aggressive</option>
                                <option value="growth">Growth Focused</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Target Risk Level</label>
                            <select id="riskLevel" class="form-select">
                                <option value="low">Low Risk (10%)</option>
                                <option value="medium" selected>Medium Risk (15%)</option>
                                <option value="high">High Risk (25%)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Action</label><br>
                            <div class="btn-group d-grid">
                                <button id="optimizeBtn" class="btn btn-primary">
                                    <i class="fas fa-magic"></i> ML Optimize
                                </button>
                                <button id="dynamicRebalanceBtn" class="btn btn-success">
                                    <i class="fas fa-sync-alt"></i> Dynamic Rebalance
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Optimization Results -->
        <div class="row">
            <!-- Market Regime & Metrics -->
            <div class="col-lg-4">
                <div class="optimization-card p-3">
                    <h6><i class="fas fa-chart-line"></i> Market Analysis</h6>
                    
                    <!-- Market Regime -->
                    <div class="text-center mb-3">
                        <div id="marketRegime" class="regime-sideways text-white p-3 rounded">
                            <div class="h5 mb-1">SIDEWAYS</div>
                            <small>Market Regime</small>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Confidence: <span id="regimeConfidence">--</span></small>
                        </div>
                    </div>

                    <!-- Key Metrics -->
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h6 text-success" id="expectedReturn">--</div>
                                <small class="text-muted">Expected Return</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h6 text-warning" id="expectedRisk">--</div>
                                <small class="text-muted">Expected Risk</small>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 text-center">
                        <div class="confidence-ring">
                            <svg viewBox="0 0 80 80">
                                <circle cx="40" cy="40" r="35" stroke="#e9ecef" stroke-width="6" fill="none"></circle>
                                <circle id="confidenceCircle" cx="40" cy="40" r="35" stroke="#667eea" stroke-width="6" 
                                        fill="none" stroke-dasharray="220" stroke-dashoffset="220"></circle>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div id="confidenceScore" class="fw-bold">--</div>
                                <small class="text-muted">Confidence</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommended Weights -->
            <div class="col-lg-4">
                <div class="optimization-card p-3">
                    <h6><i class="fas fa-balance-scale"></i> Recommended Allocation</h6>
                    
                    <div id="weightAllocation">
                        <!-- Weight bars will be populated here -->
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-spinner fa-pulse"></i><br>
                            Run optimization to see recommendations
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="row">
                            <div class="col-6 text-center">
                                <div id="sharpeRatio" class="h6 text-info">--</div>
                                <small class="text-muted">Sharpe Ratio</small>
                            </div>
                            <div class="col-6 text-center">
                                <div id="diversificationScore" class="h6 text-secondary">--</div>
                                <small class="text-muted">Diversification</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights -->
            <div class="col-lg-4">
                <div class="optimization-card p-3">
                    <h6><i class="fas fa-lightbulb"></i> AI Insights</h6>
                    
                    <div id="aiInsights" class="small">
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-robot"></i><br>
                            AI analysis will appear here after optimization
                        </div>
                    </div>

                    <div class="mt-3">
                        <div class="alert alert-info" id="rebalancingAlert" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>Rebalancing Recommended</strong>
                            <p class="mb-0 small">Your portfolio has drifted from optimal allocation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rebalancing Trades -->
        <div class="row">
            <div class="col-12">
                <div class="optimization-card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6><i class="fas fa-exchange-alt"></i> Rebalancing Trades</h6>
                        <button id="executeRebalancingBtn" class="btn btn-sm btn-success" style="display: none;">
                            <i class="fas fa-play"></i> Execute Trades
                        </button>
                    </div>
                    
                    <div id="rebalancingTrades">
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-chart-bar"></i><br>
                            No rebalancing trades needed
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optimization History -->
        <div class="row">
            <div class="col-lg-6">
                <div class="optimization-card p-3">
                    <h6><i class="fas fa-history"></i> Optimization History</h6>
                    
                    <div class="optimization-timeline" id="optimizationHistory">
                        <!-- Timeline items will be populated here -->
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-clock"></i><br>
                            No optimization history yet
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="col-lg-6">
                <div class="optimization-card p-3">
                    <h6><i class="fas fa-chart-area"></i> ML Performance Metrics</h6>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="metric-card">
                                <div id="avgSharpeRatio" class="h5 text-primary">--</div>
                                <small class="text-muted">Avg Sharpe Ratio</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card">
                                <div id="rebalancingFreq" class="h5 text-info">--</div>
                                <small class="text-muted">Rebalancing Rate</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="metric-card">
                                <div id="modelAccuracy" class="h5 text-success">--</div>
                                <small class="text-muted">Model Accuracy</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card">
                                <div id="optimizationCount" class="h5 text-warning">--</div>
                                <small class="text-muted">Total Optimizations</small>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <h6 class="small">Market Regime Distribution (30 days)</h6>
                        <div id="regimeDistribution">
                            <!-- Regime distribution chart will go here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <h6>ðŸ§  ML Optimization Running...</h6>
                    <p class="small text-muted">Analyzing market conditions and calculating optimal weights</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentOptimizationResult = null;
        let loadingModal = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            
            // Load initial data
            loadOptimizationHistory();
            loadPerformanceMetrics();
            
            // Auto-refresh every 2 minutes
            setInterval(loadPerformanceMetrics, 120000);
        });

        document.getElementById('optimizeBtn').addEventListener('click', async function() {
            const portfolioName = document.getElementById('portfolioSelect').value;
            const optimizationType = document.getElementById('optimizationType').value;
            
            await runOptimization(portfolioName, optimizationType);
        });

        document.getElementById('dynamicRebalanceBtn').addEventListener('click', async function() {
            const portfolioName = document.getElementById('portfolioSelect').value;
            
            await runDynamicRebalancing(portfolioName);
        });

        async function runOptimization(portfolioName, optimizationType) {
            try {
                // Show loading modal
                loadingModal.show();
                
                const response = await fetch('/api/ml-optimization/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        portfolio_name: portfolioName,
                        optimization_type: optimizationType
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                currentOptimizationResult = result;
                displayOptimizationResult(result);
                loadRebalancingTrades();
                loadOptimizationHistory();
                
                // Hide loading modal
                loadingModal.hide();
                
            } catch (error) {
                console.error('Optimization failed:', error);
                loadingModal.hide();
                alert('Optimization failed: ' + error.message);
            }
        }

        function displayOptimizationResult(result) {
            // Market Regime
            const regimeElement = document.getElementById('marketRegime');
            const regimeClass = `regime-${result.market_regime}`;
            regimeElement.className = `${regimeClass} text-white p-3 rounded`;
            regimeElement.querySelector('.h5').textContent = result.market_regime.toUpperCase();
            document.getElementById('regimeConfidence').textContent = `${(result.confidence_score * 100).toFixed(1)}%`;
            
            // Key Metrics
            document.getElementById('expectedReturn').textContent = `${(result.expected_return * 100).toFixed(2)}%`;
            document.getElementById('expectedRisk').textContent = `${(result.expected_risk * 100).toFixed(2)}%`;
            document.getElementById('sharpeRatio').textContent = result.sharpe_ratio.toFixed(3);
            
            // Confidence Ring
            const confidence = result.confidence_score * 100;
            const circumference = 2 * Math.PI * 35;
            const offset = circumference - (confidence / 100) * circumference;
            document.getElementById('confidenceCircle').style.strokeDashoffset = offset;
            document.getElementById('confidenceScore').textContent = `${confidence.toFixed(0)}%`;
            
            // Weight Allocation
            displayWeightAllocation(result.recommended_weights);
            
            // Diversification Score (calculated from weights)
            const weights = Object.values(result.recommended_weights);
            const diversification = (1 - weights.reduce((sum, w) => sum + w*w, 0)) * 100;
            document.getElementById('diversificationScore').textContent = `${diversification.toFixed(0)}%`;
            
            // AI Insights
            displayAIInsights(result);
            
            // Rebalancing Alert
            const rebalancingAlert = document.getElementById('rebalancingAlert');
            if (result.rebalancing_required) {
                rebalancingAlert.style.display = 'block';
                document.getElementById('executeRebalancingBtn').style.display = 'inline-block';
            } else {
                rebalancingAlert.style.display = 'none';
                document.getElementById('executeRebalancingBtn').style.display = 'none';
            }
        }

        function displayWeightAllocation(weights) {
            const container = document.getElementById('weightAllocation');
            container.innerHTML = '';
            
            const sortedWeights = Object.entries(weights).sort((a, b) => b[1] - a[1]);
            
            sortedWeights.forEach(([coinId, weight]) => {
                const div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small fw-bold">${coinId.toUpperCase()}</span>
                        <span class="small">${(weight * 100).toFixed(1)}%</span>
                    </div>
                    <div class="weight-bar">
                        <div class="weight-fill" style="width: ${weight * 100}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function displayAIInsights(result) {
            const container = document.getElementById('aiInsights');
            container.innerHTML = '';
            
            result.reasoning.forEach(reason => {
                const div = document.createElement('div');
                div.className = 'mb-2 p-2 bg-light rounded';
                div.innerHTML = `<i class="fas fa-lightbulb text-warning"></i> ${reason}`;
                container.appendChild(div);
            });
        }

        async function loadRebalancingTrades() {
            if (!currentOptimizationResult) return;
            
            try {
                const response = await fetch('/api/ml-optimization/rebalancing-trades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        portfolio_name: currentOptimizationResult.portfolio_name,
                        optimization_result: currentOptimizationResult
                    })
                });
                
                const trades = await response.json();
                displayRebalancingTrades(trades);
                
            } catch (error) {
                console.error('Failed to load rebalancing trades:', error);
            }
        }

        function displayRebalancingTrades(trades) {
            const container = document.getElementById('rebalancingTrades');
            
            if (!trades || trades.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-check-circle text-success"></i><br>
                        Portfolio is optimally balanced
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            trades.forEach(trade => {
                const tradeClass = trade.action === 'BUY' ? 'trade-buy' : 'trade-sell';
                const icon = trade.action === 'BUY' ? 'fa-plus' : 'fa-minus';
                
                const div = document.createElement('div');
                div.className = `trade-card ${tradeClass}`;
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">
                                <i class="fas ${icon}"></i> ${trade.action} ${trade.coin_id.toUpperCase()}
                            </span>
                            <div class="small text-muted">${trade.reason}</div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">â‚¬${trade.value_eur.toFixed(2)}</div>
                            <div class="small text-muted">${trade.quantity.toFixed(6)} coins</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function loadOptimizationHistory() {
            try {
                const response = await fetch('/api/ml-optimization/history?limit=10');
                const history = await response.json();
                
                const container = document.getElementById('optimizationHistory');
                
                if (!history || history.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted p-4">
                            <i class="fas fa-clock"></i><br>
                            No optimization history yet
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'timeline-item';
                    div.innerHTML = `
                        <div class="small text-muted">${new Date(item.timestamp).toLocaleString()}</div>
                        <div class="fw-bold">${item.optimization_type} - ${item.portfolio_name}</div>
                        <div class="small">
                            Return: ${(item.expected_return * 100).toFixed(2)}% | 
                            Risk: ${(item.expected_risk * 100).toFixed(2)}% | 
                            Regime: ${item.market_regime}
                        </div>
                    `;
                    container.appendChild(div);
                });
                
            } catch (error) {
                console.error('Failed to load optimization history:', error);
            }
        }

        async function loadPerformanceMetrics() {
            try {
                const response = await fetch('/api/ml-optimization/performance?days=30');
                const metrics = await response.json();
                
                if (metrics.error) return;
                
                document.getElementById('avgSharpeRatio').textContent = metrics.avg_sharpe_ratio?.toFixed(3) || '--';
                document.getElementById('rebalancingFreq').textContent = `${(metrics.rebalancing_rate * 100).toFixed(0)}%` || '--';
                document.getElementById('modelAccuracy').textContent = `${(metrics.avg_confidence_score * 100).toFixed(0)}%` || '--';
                document.getElementById('optimizationCount').textContent = metrics.total_optimizations || '0';
                
                // Display regime distribution
                displayRegimeDistribution(metrics.market_regime_distribution || {});
                
            } catch (error) {
                console.error('Failed to load performance metrics:', error);
            }
        }

        function displayRegimeDistribution(distribution) {
            const container = document.getElementById('regimeDistribution');
            container.innerHTML = '';
            
            const total = Object.values(distribution).reduce((sum, count) => sum + count, 0);
            
            if (total === 0) {
                container.innerHTML = '<small class="text-muted">No data available</small>';
                return;
            }
            
            Object.entries(distribution).forEach(([regime, count]) => {
                const percentage = (count / total) * 100;
                const div = document.createElement('div');
                div.className = 'mb-1';
                div.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <span class="small">${regime}</span>
                        <span class="small">${percentage.toFixed(0)}%</span>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar regime-${regime}" style="width: ${percentage}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function runDynamicRebalancing(portfolioName) {
            try {
                // Show loading modal with different text
                document.querySelector('#loadingModal .modal-body h6').textContent = 'ðŸ”„ Dynamic Rebalancing...';
                document.querySelector('#loadingModal .modal-body p').textContent = 'Analyzing market conditions and generating allocation signals';
                loadingModal.show();
                
                const response = await fetch('/api/dynamic-allocation/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        portfolio_name: portfolioName
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Display dynamic allocation result
                displayDynamicAllocationResult(result);
                loadOptimizationHistory();
                
                // Hide loading modal
                loadingModal.hide();
                
                // Show success message
                if (result.rebalancing_required) {
                    alert(`Dynamic rebalancing completed! ${(result.max_weight_change * 100).toFixed(1)}% max weight change detected.`);
                } else {
                    alert('Portfolio is optimally balanced. No rebalancing required.');
                }
                
            } catch (error) {
                console.error('Dynamic rebalancing failed:', error);
                loadingModal.hide();
                alert('Dynamic rebalancing failed: ' + error.message);
            }
        }

        function displayDynamicAllocationResult(result) {
            // Market Regime with dynamic styling
            const regimeElement = document.getElementById('marketRegime');
            const regimeClass = `regime-${result.market_condition.overall_trend}`;
            regimeElement.className = `${regimeClass} text-white p-3 rounded`;
            regimeElement.querySelector('.h5').textContent = result.market_condition.overall_trend.toUpperCase();
            document.getElementById('regimeConfidence').textContent = `${(result.market_condition.momentum_strength * 100).toFixed(1)}%`;
            
            // Use dynamic allocation as current result
            currentOptimizationResult = {
                portfolio_name: result.portfolio_name,
                recommended_weights: result.target_allocation,
                expected_return: 0,
                expected_risk: 0,
                sharpe_ratio: 0,
                confidence_score: result.market_condition.momentum_strength,
                market_regime: result.market_condition.overall_trend,
                rebalancing_required: result.rebalancing_required,
                reasoning: [
                    `Market trend: ${result.market_condition.overall_trend}`,
                    `Volatility: ${result.market_condition.volatility_regime}`,
                    `Allocation style: ${result.market_condition.recommended_allocation_style}`,
                    `Signals generated: ${result.allocation_signals.length}`,
                    result.recommendation
                ]
            };
            
            // Update key metrics
            document.getElementById('expectedReturn').textContent = `Dynamic`;
            document.getElementById('expectedRisk').textContent = result.market_condition.volatility_regime.toUpperCase();
            document.getElementById('sharpeRatio').textContent = 'N/A';
            
            // Confidence Ring
            const confidence = result.market_condition.momentum_strength * 100;
            const circumference = 2 * Math.PI * 35;
            const offset = circumference - (confidence / 100) * circumference;
            document.getElementById('confidenceCircle').style.strokeDashoffset = offset;
            document.getElementById('confidenceScore').textContent = `${confidence.toFixed(0)}%`;
            
            // Weight Allocation
            displayWeightAllocation(result.target_allocation);
            
            // Diversification Score
            const weights = Object.values(result.target_allocation);
            const diversification = (1 - weights.reduce((sum, w) => sum + w*w, 0)) * 100;
            document.getElementById('diversificationScore').textContent = `${diversification.toFixed(0)}%`;
            
            // AI Insights
            displayDynamicInsights(result);
            
            // Rebalancing Alert
            const rebalancingAlert = document.getElementById('rebalancingAlert');
            if (result.rebalancing_required) {
                rebalancingAlert.style.display = 'block';
                rebalancingAlert.querySelector('strong').textContent = 'Dynamic Rebalancing Recommended';
                rebalancingAlert.querySelector('p').textContent = result.recommendation;
                document.getElementById('executeRebalancingBtn').style.display = 'inline-block';
            } else {
                rebalancingAlert.style.display = 'none';
                document.getElementById('executeRebalancingBtn').style.display = 'none';
            }
            
            // Load rebalancing trades
            loadDynamicRebalancingTrades(result);
        }

        function displayDynamicInsights(result) {
            const container = document.getElementById('aiInsights');
            container.innerHTML = '';
            
            // Market condition insights
            const marketInsight = document.createElement('div');
            marketInsight.className = 'mb-2 p-2 bg-info bg-opacity-10 rounded';
            marketInsight.innerHTML = `
                <i class="fas fa-chart-line text-info"></i> 
                <strong>Market:</strong> ${result.market_condition.overall_trend} trend, ${result.market_condition.volatility_regime} volatility
            `;
            container.appendChild(marketInsight);
            
            // Allocation signals
            if (result.allocation_signals && result.allocation_signals.length > 0) {
                result.allocation_signals.slice(0, 3).forEach(signal => {
                    const signalDiv = document.createElement('div');
                    signalDiv.className = 'mb-2 p-2 bg-light rounded';
                    const signalIcon = signal.direction === 'increase' ? 'fa-arrow-up text-success' : 
                                     signal.direction === 'decrease' ? 'fa-arrow-down text-danger' : 
                                     'fa-minus text-secondary';
                    signalDiv.innerHTML = `<i class="fas ${signalIcon}"></i> ${signal.reasoning}`;
                    container.appendChild(signalDiv);
                });
            }
            
            // Recommendation
            const recommendationDiv = document.createElement('div');
            recommendationDiv.className = 'mb-2 p-2 bg-warning bg-opacity-10 rounded';
            recommendationDiv.innerHTML = `
                <i class="fas fa-lightbulb text-warning"></i> 
                <strong>Recommendation:</strong> ${result.recommendation}
            `;
            container.appendChild(recommendationDiv);
        }

        function loadDynamicRebalancingTrades(result) {
            const trades = [];
            const currentAllocation = result.current_allocation || {};
            const targetAllocation = result.target_allocation || {};
            
            for (const [asset, targetWeight] of Object.entries(targetAllocation)) {
                const currentWeight = currentAllocation[asset] || 0;
                const weightDiff = targetWeight - currentWeight;
                
                if (Math.abs(weightDiff) > 0.01) {
                    trades.push({
                        coin_id: asset,
                        action: weightDiff > 0 ? 'BUY' : 'SELL',
                        weight_change: weightDiff,
                        reason: `Adjust from ${(currentWeight * 100).toFixed(1)}% to ${(targetWeight * 100).toFixed(1)}%`,
                        value_eur: Math.abs(weightDiff) * 10000
                    });
                }
            }
            
            displayRebalancingTrades(trades);
        }
    </script>
</body>
</html>